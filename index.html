<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Advanced Music Theory Tool</title>
    <style>
/* Base Variables */
:root {
    --bg-primary: #121212;
    --bg-secondary: #1e1e1e;
    --text-primary: #ffffff;
    --text-secondary: #b3b3b3;
    --scale-color: #00ff9d;
    --root-color: #ff006e;
    --fifth-color: #8a2be2;
    --fourth-color: #FF8C00;
    --border-color: #333333;
    --hover-color: #2a2a2a;
    --key-active: #3a3a3a;
    
    /* Mobile-specific variables */
    --keyboard-height-mobile: 80px;
    --keyboard-width-mobile: 100%;
    --control-padding-mobile: 8px;
}

/* Base Styles */
* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

body {
    font-family: 'Arial', sans-serif;
    max-width: 100%;
    margin: 0;
    padding: 10px;
    background-color: var(--bg-primary);
    color: var(--text-primary);
    overflow-x: hidden;
}

/* Container Responsiveness */
.container {
    display: grid;
    gap: 10px;
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 10px;
}

/* Keyboard Styles */
.keyboard-container {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding: 5px 0;
    margin: 10px 0;
}

.keyboard {
    position: relative;
    height: 120px;
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 10px;
    user-select: none;
    min-width: 300px;
    width: 100%;
    max-width: 600px;
    overflow-x: auto;
    border: 1px solid var(--border-color);
}

/* Key Styles with Touch Optimization */
.key {
    position: absolute;
    border: 1px solid var(--border-color);
    border-radius: 0 0 4px 4px;
    cursor: pointer;
    transition: transform 0.15s ease, background-color 0.3s ease;
    touch-action: manipulation;
}

.white {
    width: 40px;
    height: 120px;
    background: #ffffff;
}

.black {
    width: 24px;
    height: 80px;
    background: #000000;
    z-index: 1;
}

/* Touch-friendly hover states */
@media (hover: hover) {
    .key:hover {
        opacity: 0.8;
        transform: translateY(1px);
    }
}

/* Active states for touch devices */
.key:active {
    transform: translateY(2px);
    opacity: 0.7;
}

/* Controls Responsiveness */
.controls {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
    margin-bottom: 15px;
}

@media (min-width: 768px) {
    .controls {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
}

.control-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 15px;
}

@media (min-width: 768px) {
    .control-group {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 20px;
    }
}

.control-item {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
}

@media (min-width: 768px) {
    .control-item {
        width: auto;
        min-width: 200px;
    }
}

/* Form Elements */
select, input[type="number"], button {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    padding: 12px;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
    font-size: 16px; /* Prevents iOS zoom on focus */
    max-width: 300px;
}

/* Button Optimization */
button {
    background: var(--root-color);
    color: var(--text-primary);
    border: none;
    padding: 15px 30px;
    border-radius: 4px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 44px; /* Touch target size */
}

/* Progression Components */
.progression-header {
    font-size: 1.1em;
    margin: 15px 0;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
    text-align: center;
}

.progression-controls {
    background: var(--bg-secondary);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    border: 1px solid var(--border-color);
}

.mode-toggles {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
    margin: 15px 0;
}

@media (min-width: 768px) {
    .mode-toggles {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
    }
}

/* Chord List Responsiveness */
.chord-list {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
    margin-top: 15px;
}

@media (min-width: 768px) {
    .chord-list {
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 16px;
    }
}

.chord-item {
    background: var(--bg-secondary);
    padding: 15px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    cursor: pointer;
    position: relative;
    transition: all 0.3s ease;
}

/* Play Button Mobile Optimization */
.play-chord-button {
    position: absolute;
    top: 50%;
    right: 12px;
    transform: translateY(-50%);
    background: var(--root-color);
    color: var(--text-primary);
    border: none;
    padding: 12px 20px;
    border-radius: 4px;
    cursor: pointer;
    min-height: 44px;
    opacity: 1; /* Always visible on mobile */
}

@media (min-width: 768px) {
    .play-chord-button {
        opacity: 0;
    }
    
    .chord-item:hover .play-chord-button {
        opacity: 1;
    }
}

/* Legend Responsiveness */
.legend {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin: 15px 0;
    padding: 15px;
    background: var(--bg-secondary);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

@media (min-width: 768px) {
    .legend {
        display: flex;
        justify-content: center;
        gap: 20px;
    }
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9em;
}

/* Developer Credit */
.developer-credit {
    text-align: center;
    color: var(--text-secondary);
    font-size: 0.85em;
    margin: 10px 0;
    font-style: italic;
}

/* Mobile Safari Specific Fixes */
@supports (-webkit-touch-callout: none) {
    select, input[type="number"] {
        padding: 12px 8px;
    }
    
    .keyboard {
        -webkit-overflow-scrolling: touch;
    }
}

/* Dark Mode Support */
@media (prefers-color-scheme: dark) {
    .key.white {
        background: #f0f0f0;
    }
    
    .key.black {
        background: #1a1a1a;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="key-info">

            <div class="info-item">
                <span class="info-label">Scale:</span>
                <select id="scale"></select>
            </div>

            <div class="info-item">
                <span class="info-label">Base Key:</span>
                <select id="key"></select>
            </div>

            <div class="info-item" id="complementaryKeyInfo">
                <span class="info-label">Up 5th Key:</span>
                <span></span>
            </div>

            <div class="info-item" id="fourthKeyInfo">
                <span class="info-label">Down 4th Key:</span>
                <span></span>
            </div>

            <div class="info-item">
                <span class="info-label">Mood:</span>
                <select id="mood">
                    <option value="happy">Happy</option>
                    <option value="sad">Sad</option>
                    <option value="mysterious">Mysterious</option>
                    <option value="epic">Epic</option>
                    <option value="romantic">Romantic</option>
                    <option value="melancholic">Melancholic</option>
                    <option value="dreamy">Dreamy</option>
                    <option value="tense">Tense</option>
                    <option value="peaceful">Peaceful</option>
                </select>
            </div>

        </div>

        <div class="developer-credit">developed by elkmire</div>
        
        <div class="keyboard-container">
            <div class="keyboard" id="keyboard"></div>
        </div>
        
        <div class="legend">

            <div class="legend-item">
                <div class="color-box" style="background: var(--root-color)"></div>
                <span>Root Note</span>
            </div>

            <div class="legend-item">
                <div class="color-box" style="background: var(--scale-color)"></div>
                <span>Scale Notes</span>
            </div>

            <div class="legend-item">
                <div class="color-box" style="background: var(--fifth-color)"></div>
                <span>Circle of 5ths</span>
            </div>

            <div class="legend-item">
                <div class="color-box" style="background: var(--fourth-color)"></div>
                <span>Circle of 4ths</span>
            </div>
        </div>

        <div class="progression">
            <div class="progression-header">Chord Progression Generator</div>
            
            <div class="progression-controls">
                <div class="control-group">
                    <div class="control-item">
                        <label for="chordCount">Number of Chords:</label>
                        <input type="number" id="chordCount" min="2" max="8" value="4">
                    </div>
                </div>
                
                <div class="mode-toggles">
                    <div class="toggle-switch">
                        <input type="checkbox" id="seventhMode">
                        <label for="seventhMode">+7th Chords</label>
                    </div>
                    <div class="toggle-switch">
                        <input type="checkbox" id="advancedMode">
                        <label for="advancedMode">+ 9th/11th Chords</label>
                    </div>
                    <div class="toggle-switch">
                        <input type="checkbox" id="complexMode">
                        <label for="complexMode">Complex Mode</label>
                    </div>
                </div>
                
                <div class="key-behavior-note">
                    Note: Changing the base key will update existing progressions. Changes to scale or mood require generating a new progression.
                </div>
                
                <div class="generate-button-container">
                    <button onclick="generateProgression()">Generate Progression</button>
                </div>
            </div>
            
            <div class="progression-output">
                <div id="progressionOutput"></div>
            </div>
        </div>
    </div>

    <script>
        let audioContext = null;

        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        const SCALES = {
            'major': [0, 2, 4, 5, 7, 9, 11],
            'minor': [0, 2, 3, 5, 7, 8, 10],
            'harmonic_minor': [0, 2, 3, 5, 7, 8, 11],
            'melodic_minor': [0, 2, 3, 5, 7, 9, 11],
            'dorian': [0, 2, 3, 5, 7, 9, 10],
            'phrygian': [0, 1, 3, 5, 7, 8, 10],
            'lydian': [0, 2, 4, 6, 7, 9, 11],
            'mixolydian': [0, 2, 4, 5, 7, 9, 10],
            'locrian': [0, 1, 3, 5, 6, 8, 10],
            'hungarian_minor': [0, 2, 3, 6, 7, 8, 11],
            'persian': [0, 1, 4, 5, 6, 8, 11],
            'japanese': [0, 2, 5, 7, 8],
            'arabic': [0, 2, 4, 5, 6, 8, 10],
            'egyptian': [0, 2, 5, 7, 10],
            'chinese': [0, 4, 6, 7, 11],
            'altered': [0, 1, 3, 4, 6, 8, 10],
            'diminished': [0, 2, 3, 5, 6, 8, 9, 11],
            'whole_tone': [0, 2, 4, 6, 8, 10],
            'chromatic': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
        };

        const NOTE_FREQUENCIES = {
            // First octave (C4-B4)
            'C': 261.63,   // C4
            'C#': 277.18,  // C#4
            'D': 293.66,   // D4
            'D#': 311.13,  // D#4
            'E': 329.63,   // E4
            'F': 349.23,   // F4
            'F#': 369.99,  // F#4
            'G': 392.00,   // G4
            'G#': 415.30,  // G#4
            'A': 440.00,   // A4
            'A#': 466.16,  // A#4
            'B': 493.88,   // B4
            
            // Second octave (C5-B5)
            'C2': 523.25,  // C5
            'C#2': 554.37, // C#5
            'D2': 587.33,  // D5
            'D#2': 622.25, // D#5
            'E2': 659.26,  // E5
            'F2': 698.46,  // F5
            'F#2': 739.99, // F#5
            'G2': 783.99,  // G5
            'G#2': 830.61, // G#5
            'A2': 880.00,  // A5
            'A#2': 932.33, // A#5
            'B2': 987.77   // B5
        };

        const CHORD_TYPES = {
            seventh: {
                // Proper diatonic seventh chords based on scale degree
                I: [0, 4, 7, 11],    // maj7
                II: [0, 3, 7, 10],   // min7
                III: [0, 3, 7, 10],  // min7
                IV: [0, 4, 7, 11],   // maj7
                V: [0, 4, 7, 10],    // dom7
                VI: [0, 3, 7, 10],   // min7
                VII: [0, 3, 6, 10],  // min7b5
                // Altered seventh chords
                bII: [0, 4, 7, 10],  // dom7
                bIII: [0, 4, 7, 10], // dom7
                bV: [0, 4, 7, 10],   // dom7
                bVI: [0, 4, 7, 10],  // dom7
                bVII: [0, 4, 7, 10]  // dom7
            },
            basic: {
                major: [0, 4, 7],
                minor: [0, 3, 7],
                diminished: [0, 3, 6],
                augmented: [0, 4, 8]
            },
            advanced: {
                major7: [0, 4, 7, 11],
                minor7: [0, 3, 7, 10],
                dom7: [0, 4, 7, 10],
                maj9: [0, 4, 7, 11, 14],
                min9: [0, 3, 7, 10, 14],
                dom9: [0, 4, 7, 10, 14],
                maj11: [0, 4, 7, 11, 14, 17],
                min11: [0, 3, 7, 10, 14, 17]
            }
        };

        const MOOD_PROGRESSIONS = {
            happy: {
                patterns: [
                    ['I', 'IV', 'V', 'I'],
                    ['I', 'VI', 'IV', 'V'],
                    ['I', 'IV', 'I', 'V']
                ]
            },
            sad: {
                patterns: [
                    ['I', 'VI', 'IV', 'V'],
                    ['VI', 'IV', 'I', 'V'],
                    ['I', 'III', 'VI', 'IV']
                ]
            },
            mysterious: {
                patterns: [
                    ['I', 'bII', 'IV', 'bVII'],
                    ['I', 'VI', 'III', 'VII'],
                    ['I', 'V', 'bVII', 'IV']
                ]
            },
            epic: {
                patterns: [
                    ['I', 'V', 'VI', 'IV'],
                    ['I', 'bVII', 'VI', 'V'],
                    ['I', 'III', 'VI', 'VII']
                ]
            },
            romantic: {
                patterns: [
                    ['I', 'VI', 'II', 'V'],
                    ['I', 'IV', 'II', 'V'],
                    ['I', 'III', 'IV', 'V']
                ]
            },
            melancholic: {
                patterns: [
                    ['I', 'bVI', 'bIII', 'bVII'],
                    ['I', 'bIII', 'IV', 'VI'],
                    ['VI', 'bIII', 'bVII', 'I']
                ]
            },
            dreamy: {
                patterns: [
                    ['I', 'bVII', 'IV', 'VI'],
                    ['I', 'III', 'bVI', 'IV'],
                    ['I', 'VI', 'bVII', 'V']
                ]
            },
            tense: {
                patterns: [
                    ['I', 'bII', 'bV', 'VII'],
                    ['I', 'VI', 'bII', 'V'],
                    ['I', 'bV', 'bII', 'VII']
                ]
            },
            peaceful: {
                patterns: [
                    ['I', 'IV', 'III', 'VI'],
                    ['I', 'III', 'VI', 'IV'],
                    ['I', 'VI', 'IV', 'III']
                ]
            }
        };

        function initUI() {
            const scaleSelect = document.getElementById('scale');
            const keySelect = document.getElementById('key');
            
            Object.keys(SCALES).forEach(scale => {
                const option = document.createElement('option');
                option.value = scale;
                option.textContent = scale.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                scaleSelect.appendChild(option);
            });
            
            NOTES.forEach(note => {
                const option = document.createElement('option');
                option.value = note;
                option.textContent = note;
                keySelect.appendChild(option);
            });
            
            createKeyboard();
            
            scaleSelect.addEventListener('change', updateKeyboard);
            keySelect.addEventListener('change', updateKeyboard);
            
            updateKeyboard();
        }

        function initAudioContext() {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.error('Web Audio API is not supported in this browser');
                }
            }

        // For single note playback (in the playNote function):
        function playNote(note) {
            if (!audioContext) {
                initAudioContext();
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            // Set note frequency
            const baseFreq = NOTE_FREQUENCIES[note];
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(baseFreq, audioContext.currentTime);
            
            // Configure envelope
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.05);
            // Increase these times to make the note longer
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1.5);
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 1.6); 
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 1.6);
        }

        // For chord playback (in the playChord function):
        function playChord(notes) {
            if (!audioContext) {
                initAudioContext();
            }

            notes.forEach((note, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                let baseFreq = NOTE_FREQUENCIES[note];
                if (index === 0) baseFreq = baseFreq / 2;
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(baseFreq, audioContext.currentTime);
                
                const startTime = audioContext.currentTime + (index * 0.02);
                gainNode.gain.setValueAtTime(0, startTime);
                gainNode.gain.linearRampToValueAtTime(0.3, startTime + 0.05);
                // Increase these times to make the chord notes longer
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 2.0);
                gainNode.gain.linearRampToValueAtTime(0, startTime + 2.2);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + 2.2); 
            });
        }

        function createKeyboard() {
            const keyboard = document.getElementById('keyboard');
            const whiteKeys = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const blackKeys = ['C#', 'D#', 'F#', 'G#', 'A#'];
            
            // Create two octaves
            for (let octave = 0; octave < 2; octave++) {
                // White keys
                whiteKeys.forEach((note, i) => {
                    const key = document.createElement('div');
                    key.className = 'key white';
                    // Add '2' suffix for second octave
                    key.dataset.note = octave === 0 ? note : note + '2';
                    key.style.left = `${(i + octave * 7) * 40}px`;
                    
                    // Add click handler
                    key.addEventListener('click', () => {
                        playNote(key.dataset.note);
                        // Add visual feedback
                        key.style.transform = 'translateY(2px)';
                        setTimeout(() => {
                            key.style.transform = 'translateY(0)';
                        }, 150);
                    });
                    
                    keyboard.appendChild(key);
                });
                
                // Black keys
                blackKeys.forEach((note, i) => {
                    const key = document.createElement('div');
                    key.className = 'key black';
                    // Add '2' suffix for second octave
                    key.dataset.note = octave === 0 ? note : note + '2';
                    const offset = [1, 2, 4, 5, 6][i];
                    key.style.left = `${(offset + octave * 7) * 40 - 12}px`;
                    
                    // Add click handler
                    key.addEventListener('click', () => {
                        playNote(key.dataset.note);
                        // Add visual feedback
                        key.style.transform = 'translateY(2px)';
                        setTimeout(() => {
                            key.style.transform = 'translateY(0)';
                        }, 150);
                    });
                    
                    keyboard.appendChild(key);
                });
            }
        }

        function updateKeyboard() {
            const scale = document.getElementById('scale').value;
            const key = document.getElementById('key').value;
            const scaleNotes = getScaleNotes(key, SCALES[scale]);
            const fifthNotes = getFifthNote(key);
            const fourthNotes = getFourthNote(key);
            
            // Update complementary keys display
            const complementaryKeySpan = document.querySelector('#complementaryKeyInfo span:last-child');
            const fourthKeySpan = document.querySelector('#fourthKeyInfo span:last-child');
            
            if (complementaryKeySpan) {
                complementaryKeySpan.textContent = fifthNotes[0];
                complementaryKeySpan.style.color = 'var(--fifth-color)';
            }
            
            if (fourthKeySpan) {
                fourthKeySpan.textContent = fourthNotes[0];
                fourthKeySpan.style.color = 'var(--fourth-color)';
            }
            
            // Update keyboard visualization
            document.querySelectorAll('.key').forEach(keyElement => {
                const note = keyElement.dataset.note;
                if (note === key || note === key + '2') {
                    keyElement.style.backgroundColor = 'var(--root-color)';
                } else if (fifthNotes.includes(note)) {
                    keyElement.style.backgroundColor = 'var(--fifth-color)';
                } else if (fourthNotes.includes(note)) {
                    keyElement.style.backgroundColor = 'var(--fourth-color)';
                } else if (scaleNotes.includes(note)) {
                    keyElement.style.backgroundColor = 'var(--scale-color)';
                } else {
                    keyElement.style.backgroundColor = keyElement.classList.contains('white') ? 'white' : '#333';
                }
            });
            
            // Update existing progression if one exists
            const progressionOutput = document.getElementById('progressionOutput');
            if (progressionOutput.textContent.trim() !== '') {
                updateExistingProgression(key);
            }
        }

        function updateExistingProgression(newKey) {
            const outputEl = document.getElementById('progressionOutput');
            if (!outputEl.textContent) return;
            
            // Get the current progression details
            const chordItems = document.querySelectorAll('.chord-item');
            if (!chordItems.length) return;
            
            const scale = document.getElementById('scale').value;
            const fifthKey = NOTES[(NOTES.indexOf(newKey) + 7) % 12];
            const modes = {
                seventh: document.getElementById('seventhMode').checked,
                advanced: document.getElementById('advancedMode').checked,
                complex: document.getElementById('complexMode').checked
            };
            
            // Update key information display
            const keysDiv = outputEl.querySelector('.progression-keys');
            if (keysDiv) {
                keysDiv.textContent = `Base Key: ${newKey}  -  Complementary Key: ${fifthKey}`;
            }
            
            // Update each chord based on the new key
            const newChords = [];
            chordItems.forEach((item) => {
                const chordSymbolEl = item.querySelector('.chord-symbol');
                const chordText = chordSymbolEl.textContent;
                const degreeMatch = chordText.match(/\((.*?)\)/);
                if (degreeMatch) {
                    const degree = degreeMatch[1];
                    const rootIndex = romanToNumber(degree);
                    const scaleNotes = getScaleNotes(newKey, SCALES[scale]);
                    let chordRoot = scaleNotes[rootIndex % scaleNotes.length];
                    
                    const chordType = getChordQuality(degree);
                    const notes = getChordNotes(chordRoot, degree, chordType, modes);
                    
                    // Format chord symbol
                    let chordSymbol = chordRoot + chordType;
                    if (modes.advanced || modes.seventh) {
                        chordSymbol += notes.length > 3 ? (notes.length === 4 ? '7' : notes.length === 5 ? '9' : '11') : '';
                    }
                    
                    newChords.push(chordSymbol);
                    
                    // Update display
                    chordSymbolEl.textContent = `Chord ${Array.from(chordItems).indexOf(item) + 1} (${degree}): ${chordSymbol}`;
                    item.querySelector('.chord-notes').textContent = `Notes: ${notes.join(', ')}`;
                }
            });
            
            // Update progression sequence
            const sequenceDiv = outputEl.querySelector('.progression-sequence');
            if (sequenceDiv) {
                sequenceDiv.textContent = `Progression: ${newChords.join(' → ')}`;
            }
        }

        function getScaleNotes(key, intervals) {
            const keyIndex = NOTES.indexOf(key);
            // Get regular scale notes
            const firstOctave = intervals.map(interval => 
                NOTES[(keyIndex + interval) % 12]
            );
            // Add second octave notes with '2' suffix
            const secondOctave = intervals.map(interval => 
                NOTES[(keyIndex + interval) % 12] + '2'
            );
            return [...firstOctave, ...secondOctave];
        }

        function getFifthNote(key) {
            const keyIndex = NOTES.indexOf(key);
            const firstOctave = NOTES[(keyIndex + 7) % 12];
            const secondOctave = NOTES[(keyIndex + 7) % 12] + '2';
            return [firstOctave, secondOctave];
        }

        function getFourthNote(key) {
            const keyIndex = NOTES.indexOf(key);
            const firstOctave = NOTES[(keyIndex + 5) % 12];
            const secondOctave = NOTES[(keyIndex + 5) % 12] + '2';
            return [firstOctave, secondOctave];
        }

        function getChordNotes(root, degree, type, modes) {
            const rootIndex = NOTES.indexOf(root);
            let intervals;
            
            if (modes.seventh) {
                // Use proper diatonic seventh chords based on scale degree
                intervals = CHORD_TYPES.seventh[degree];
            } else if (modes.advanced) {
                // Use extended chord voicings
                const advancedTypes = Object.keys(CHORD_TYPES.advanced);
                const randomType = advancedTypes[Math.floor(Math.random() * advancedTypes.length)];
                intervals = CHORD_TYPES.advanced[randomType];
            } else {
                // Use basic triads
                intervals = type.includes('m') ? CHORD_TYPES.basic.minor :
                        type.includes('dim') ? CHORD_TYPES.basic.diminished :
                        type.includes('aug') ? CHORD_TYPES.basic.augmented :
                        CHORD_TYPES.basic.major;
            }
            
            return intervals.map(interval => NOTES[(rootIndex + interval) % 12]);
        }

        function generateExtendedProgression(basePattern, chordCount, mood) {
            if (chordCount <= basePattern.length) {
                return basePattern.slice(0, chordCount);
            }
            
            let progression = [...basePattern];
            const moodPatterns = MOOD_PROGRESSIONS[mood].patterns;
            
            while (progression.length < chordCount) {
                // Get a different pattern from the same mood
                let nextPattern;
                do {
                    nextPattern = moodPatterns[Math.floor(Math.random() * moodPatterns.length)];
                } while (nextPattern === basePattern && moodPatterns.length > 1);
                
                // Add variation to avoid direct repetition
                const variation = generateVariation(nextPattern, mood);
                progression = progression.concat(variation);
            }
            
            return progression.slice(0, chordCount);
        }

        function generateVariation(pattern, mood) {
            // Common chord substitutions that maintain the mood
            const substitutions = {
                'I': ['I', 'III', 'VI'],
                'IV': ['IV', 'II', 'VI'],
                'V': ['V', 'VII', 'III'],
                'VI': ['VI', 'IV', 'II'],
                'II': ['II', 'IV', 'VII'],
                'III': ['III', 'VI', 'I'],
                'VII': ['VII', 'V', 'III']
            };
            
            // Apply substitutions with some probability
            return pattern.map(chord => {
                if (Math.random() < 0.3 && substitutions[chord]) { // 30% chance of substitution
                    const possibleSubs = substitutions[chord];
                    return possibleSubs[Math.floor(Math.random() * possibleSubs.length)];
                }
                return chord;
            });
        }

        function generateProgression() {
            const scale = document.getElementById('scale').value;
            const key = document.getElementById('key').value;
            const mood = document.getElementById('mood').value;
            const chordCount = parseInt(document.getElementById('chordCount').value);
            
            const modes = {
                seventh: document.getElementById('seventhMode').checked,
                advanced: document.getElementById('advancedMode').checked,
                complex: document.getElementById('complexMode').checked
            };
            
            // Get base pattern and generate extended progression
            const moodPatterns = MOOD_PROGRESSIONS[mood].patterns;
            const basePattern = moodPatterns[Math.floor(Math.random() * moodPatterns.length)];
            const progression = generateExtendedProgression(basePattern, chordCount, mood);
            
            const scaleNotes = getScaleNotes(key, SCALES[scale]);
            const fifthKey = NOTES[(NOTES.indexOf(key) + 7) % 12];
            const complementaryNotes = getScaleNotes(fifthKey, SCALES[scale]);
            const chords = [];
            const chordDetails = [];
            
            progression.forEach(degree => {
                const rootIndex = romanToNumber(degree);
                let chordRoot = scaleNotes[rootIndex % scaleNotes.length];
                
                // Apply out-of-scale alterations for complex mode
                if (modes.complex && Math.random() < 0.4) {
                    if (Math.random() < 0.5) {
                        // Use a note from the complementary scale
                        const complementaryNote = complementaryNotes[Math.floor(Math.random() * complementaryNotes.length)];
                        if (!scaleNotes.includes(complementaryNote)) {
                            chordRoot = complementaryNote;
                        }
                    } else {
                        // Chromatic alteration
                        const alteration = [-1, 1][Math.floor(Math.random() * 2)];
                        const rootNoteIndex = NOTES.indexOf(chordRoot);
                        chordRoot = NOTES[(rootNoteIndex + alteration + 12) % 12];
                    }
                }
                
                const chordType = getChordQuality(degree);
                const notes = getChordNotes(chordRoot, degree, chordType, modes);
                
                let chordSymbol = chordRoot + chordType;
                if (modes.advanced || modes.seventh) {
                    chordSymbol += notes.length > 3 ? (notes.length === 4 ? '7' : notes.length === 5 ? '9' : '11') : '';
                }
                
                chords.push(chordSymbol);
                chordDetails.push({
                    symbol: chordSymbol,
                    notes: notes,
                    degree: degree
                });
            });
            
            const outputEl = document.getElementById('progressionOutput');
            outputEl.innerHTML = '';
            
            // Display key information
            const keysDiv = document.createElement('div');
            keysDiv.className = 'progression-keys';
            keysDiv.textContent = `Base Key: ${key}  -  Complementary Key: ${fifthKey}`;
            outputEl.appendChild(keysDiv);
            
            // Display progression sequence
            const sequenceDiv = document.createElement('div');
            sequenceDiv.className = 'progression-sequence';
            sequenceDiv.textContent = `Progression: ${chords.join(' → ')}`;
            outputEl.appendChild(sequenceDiv);
            
            // Create chord list container
            const chordListDiv = document.createElement('div');
            chordListDiv.className = 'chord-list';
            
            // Add each chord detail
            chordDetails.forEach((chord, i) => {
            const chordDiv = document.createElement('div');
            chordDiv.className = 'chord-item';
            
            const chordSymbol = document.createElement('div');
            chordSymbol.className = 'chord-symbol';
            chordSymbol.textContent = `Chord ${i + 1} (${chord.degree}): ${chord.symbol}`;
            
            const chordNotes = document.createElement('div');
            chordNotes.className = 'chord-notes';
            chordNotes.textContent = `Notes: ${chord.notes.join(', ')}`;
            
            const playButton = document.createElement('button');
            playButton.className = 'play-chord-button';
            playButton.textContent = '▶ Play';
            
            const playChordHandler = () => {
                playChord(chord.notes);
                
                // Visual feedback for the chord item
                chordDiv.classList.add('playing');
                setTimeout(() => {
                    chordDiv.classList.remove('playing');
                }, 1000);
                
                // Visual feedback for the keyboard
                document.querySelectorAll('.key').forEach(key => {
                    if (chord.notes.includes(key.dataset.note)) {
                        key.style.transform = 'translateY(2px)';
                        setTimeout(() => {
                            key.style.transform = 'translateY(0)';
                        }, 1000);
                    }
                });
            };
            
            chordDiv.addEventListener('click', playChordHandler);
            playButton.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent double triggering
                playChordHandler();
            });
            
            chordDiv.appendChild(chordSymbol);
            chordDiv.appendChild(chordNotes);
            chordDiv.appendChild(playButton);
            chordListDiv.appendChild(chordDiv);
        });
        
        outputEl.appendChild(chordListDiv);
    }

        function romanToNumber(roman) {
            const numerals = {
                'I': 0, 'II': 1, 'III': 2, 'IV': 3, 'V': 4, 'VI': 5, 'VII': 6,
                'bII': 1, 'bIII': 2, 'bIV': 3, 'bV': 4, 'bVI': 5, 'bVII': 6
            };
            return numerals[roman] || 0;
        }

        function getChordQuality(degree) {
            if (degree.startsWith('b')) {
                return 'm';
            }
            return ['I', 'IV', 'V'].includes(degree) ? '' : 'm';
        }


        document.addEventListener('keydown', (event) => {
            // Prevent repeated triggers while holding key
            if (event.repeat) return;
            

            const keyMap = {
                'a': 'C',
                'w': 'C#',
                's': 'D',
                'e': 'D#',
                'd': 'E',
                'f': 'F',
                't': 'F#',
                'g': 'G',
                'y': 'G#',
                'h': 'A',
                'u': 'A#',
                'j': 'B'
            };
            
            const note = keyMap[event.key.toLowerCase()];
            if (note) {
                playNote(note);
                // Add visual feedback to the corresponding key
                const keys = document.querySelectorAll('.key');
                keys.forEach(key => {
                    if (key.dataset.note === note) {
                        key.style.transform = 'translateY(2px)';
                        setTimeout(() => {
                            key.style.transform = 'translateY(0)';
                        }, 150);
                    }
                });
            }
        });

        // Initialize the application
        initUI();
    </script>
</body>
</html>
